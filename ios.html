<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AR Viewer (iOS - Controlled)</title>
    <style>
      html, body { margin:0; height:100%; overflow:hidden; background:#000; }
      #hud{
        position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
        z-index:10; background:rgba(0,0,0,.75); color:#fff;
        padding:10px 14px; border-radius:12px;
        font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
        font-size:14px; line-height:1.25; max-width:92vw; text-align:center;
        pointer-events:none;
      }
      #btnStart{
        position:fixed; left:50%; bottom:80px; transform:translateX(-50%);
        z-index:20; border:none; border-radius:999px;
        padding:12px 18px; font-weight:700;
        font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      }
      canvas{ display:block; }
    </style>
  </head>

  <body>
    <button id="btnStart">Start AR</button>
    <div id="hud">Tap “Start AR” to request camera access.</div>

    <script type="module">
      import * as THREE from "https://esm.sh/three@0.160.0";
      import * as ZapparThree from "https://esm.sh/@zappar/zappar-threejs@2.2.2";
      import { GLTFLoader } from "https://esm.sh/three@0.160.0/examples/jsm/loaders/GLTFLoader.js";

      // ====== CONFIG ======
      const MODEL_URL = "./Siemens%20CH.glb";
      const PLACE_DISTANCE_METERS = 2.0;
      const INITIAL_MODEL_SCALE = 0.3;   // igual ao Android
      const MIN_SCALE = 0.05;
      const MAX_SCALE = 3.0;
      // ====================

      const hud = document.getElementById("hud");
      const btnStart = document.getElementById("btnStart");

      let renderer, scene, camera, tracker, anchorGroup, modelRoot, model;
      let placed = false;

      // Touch helpers
      let dragging = false, lastX = 0;
      let pinchStart = 0, startScale = INITIAL_MODEL_SCALE;
      const dist = (a,b) => Math.hypot(a.clientX-b.clientX, a.clientY-b.clientY);

      function placeInFront() {
        tracker.setAnchorPoseFromCameraOffset(0, 0, -PLACE_DISTANCE_METERS);
        if (model) model.visible = true;
        placed = true;
      }

      async function startAR() {
        btnStart.disabled = true;
        hud.textContent = "Requesting camera permission…";

        // Create renderer/scene only when user clicks (important on iOS)
        renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.body.appendChild(renderer.domElement);

        ZapparThree.glContextSet(renderer.getContext());

        scene = new THREE.Scene();
        camera = new ZapparThree.Camera();
        scene.add(camera);
        scene.background = camera.backgroundTexture;

        scene.add(new THREE.HemisphereLight(0xffffff, 0x222222, 1));

        // Permission MUST be triggered by user gesture (this click)
        const granted = await ZapparThree.permissionRequestUI();
        if (!granted) {
          hud.textContent = "Camera permission denied. Check Safari settings for this site.";
          btnStart.disabled = false;
          return;
        }

        camera.start();

        tracker = new ZapparThree.InstantWorldTracker();
        anchorGroup = new ZapparThree.InstantWorldAnchorGroup(camera, tracker);
        scene.add(anchorGroup);

        modelRoot = new THREE.Group();
        anchorGroup.add(modelRoot);

        hud.textContent = "Loading model…";

        const loader = new GLTFLoader();
        loader.load(
          MODEL_URL,
          (gltf) => {
            model = gltf.scene;
            model.visible = false;
            model.scale.setScalar(INITIAL_MODEL_SCALE);
            modelRoot.add(model);
            hud.textContent = "Tap to place. Drag to rotate. Pinch to scale.";
          },
          undefined,
          (err) => {
            console.error(err);
            hud.textContent = "Failed to load .glb. Check file name/path.";
          }
        );

        // Touch controls
        renderer.domElement.addEventListener("touchstart", (e) => {
          if (!model) return;

          if (!placed) {
            placeInFront();
            hud.textContent = "Placed. Tap again to re-place. Drag to rotate. Pinch to scale.";
            return;
          }

          if (e.touches.length === 1) {
            dragging = true;
            lastX = e.touches[0].clientX;
          } else if (e.touches.length === 2) {
            pinchStart = dist(e.touches[0], e.touches[1]);
            startScale = model.scale.x;
          }
        }, { passive:true });

        renderer.domElement.addEventListener("touchmove", (e) => {
          if (!model) return;

          if (e.touches.length === 1 && dragging) {
            const x = e.touches[0].clientX;
            const dx = x - lastX;
            lastX = x;
            modelRoot.rotation.y += dx * 0.01;
          } else if (e.touches.length === 2 && pinchStart > 0) {
            const d = dist(e.touches[0], e.touches[1]);
            const factor = d / pinchStart;
            const newScale = THREE.MathUtils.clamp(startScale * factor, MIN_SCALE, MAX_SCALE);
            model.scale.setScalar(newScale);
          }
        }, { passive:true });

        renderer.domElement.addEventListener("touchend", () => {
          dragging = false;
          pinchStart = 0;
        }, { passive:true });

        // Re-place on click
        renderer.domElement.addEventListener("click", () => {
          if (!model) return;
          if (!placed) return;
          placeInFront();
        });

        // Hide Start button once AR is running
        btnStart.style.display = "none";

        function animate() {
          requestAnimationFrame(animate);
          camera.updateFrame(renderer);
          renderer.render(scene, camera);
        }
        animate();

        window.addEventListener("resize", () => {
          renderer.setSize(window.innerWidth, window.innerHeight);
        });
      }

      btnStart.addEventListener("click", startAR);
    </script>
  </body>
</html>
